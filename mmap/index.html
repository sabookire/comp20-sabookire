<!DOCTYPE html>
<html>
<head>
	<title>Geolocation Map Example</title>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<script type="text/javascript" 
	src="http://maps.googleapis.com/maps/api/js?sensor=true&amp;libraries=places"></script>
	<link rel="stylesheet" href="style.css" />
	
	<script>
	// declare global variables
	var myLat = 0;
	var myLng = 0; 
	var map;
	var marker;
	var places;
	var params;
	var me = new google.maps.LatLng(myLat, myLng);
	var infowindow = new google.maps.InfoWindow();
	var request = new XMLHttpRequest();
	var myOptions = {
		zoom: 13,
		center: me,
		mapTypeId: google.maps.MapTypeId.ROADMAP
       };
	
	//initialize map
	function init () {
		map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
		console.log("Call before getMyLocation()");
		getMyLocation();
		console.log("Call after getMyLocation()");
	}

	// get my location
	function getMyLocation () {
		console.log("In getMyLocation()");
			if (navigator.geolocation) { // if the navigator.geolocation object is supported on your browser
				navigator.geolocation.getCurrentPosition(function(position) {
					myLat = position.coords.latitude;
					myLng = position.coords.longitude;
					loadMap();
					});
				}
			else {
				alert("Sorry! Geolocation is not supported by your web browser");
				}
				console.log("Leaving getMyLocation()");
	}

	function loadMap() {
		me = new google.maps.LatLng(myLat, myLng);
				
		// Update map and go there...
		map.panTo(me);
	
		// Create a marker
		createMarker(me, "Here I am-YAY it works!");
		/*marker = new google.maps.Marker({
		position: me,
		title: "Here I Am!"
		});*/
		
					
		// Open info window on click of marker
		google.maps.event.addListener(marker, 'click', function() {
			infowindow.setContent(marker.title);
			infowindow.open(map, marker);
		});			
	}

	function createMarker (position, title) {
		marker = new google.maps.Marker({
			position: position,
			title: title
			});
		marker.setMap(map);
}
	//got location, send it to datastore
	function sendMyLocation () {
		myloc = new XMLHttpRequest();
		params = "login=CindyLytle&lat="+myLat+"lng="+myLng;
		myloc.open("POST", "https://secret-about-box.herokuapp.com/sendLocation", true);
		myloc.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		myloc.send(params);
		parse();
	}

	function parse() {
		request.open("GET", "https://secret-about-box.herokuapp.com/sendLocation", true);
		request.onreadystatechange = parseData;
		request.send();
	}

	function parseData() {
		if (request.readyState == 4 && request.status == 200) {
			usersArr = JSON.parse(request.responseText);
			for (i = 0; i < usersArr.length; i++) {
				//stuff
			}
		}
		else if (request.readyState == 4 && request.status != 200) {
			alert("Page couldn't load");
		}
	}
</script>
</head>
<body onload = "init()">
	<h1>The Real Marauder's Map</h1>
	<div id="map_canvas"></div>
</html>